
<!DOCTYPE html>
<html>
  <head>
    <title>i3 Patch: Run authentication in different threads</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" media="screen" href="http://i3wm.org/css/style.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/public/stylesheets/main.css">
    <link rel="shortcut icon" type="image/png" href="http://i3wm.org/favicon.png">
    <script src="/public/js/jquery-1.9.0.min.js" type="text/javascript" charset="utf-8"></script>
	<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
    
    
      <script src="/public/js/patch.js" type="text/javascript" charset="utf-8"></script>
    
  </head>
  <body>


<div id="main">
	<a href="/"><h1 id="title">i3 - improved tiling WM</h1></a>
				<ul id="nav">
						<li><a style="border-bottom: 2px solid #fff" href="/">Reviews</a></li>
						<li><a href="http://bugs.i3wm.org/">Bugs</a></li>
				</ul>
<br style="clear: both">

<div id="content">

<h1>Run authentication in different threads</h1>
<div style="float: right">
<p>
Patch status: needinfo
</p>
<p>
Patch by Philippe Virouleau
</p>
</div>

<p>
<strong>Long description</strong>:<br>
<pre>This replaces the commit a305e622, and fixes #895 as well as the bugs
introduced by the previous commit (reported in #1090). It uses pthread
and lock-free synchronization with gcc builtins atomic operations.
</pre>
</p>


<p>
To apply this patch, use:<br>
<code>curl http://cr.i3wm.org/patch/244/raw.patch | git am</code>
</p>




<div style="border: 1px solid #ccc; margin: 1em; width: 880px; overflow-x: auto; background-color: #eaeaea; color: #000;">
<h2 style="margin: 0; padding: .5em; color: #000;">b/i3lock.c</h2>
<table class="patch" cellpadding="0" cellspacing="0">


  <tr class="linerow">
  <td class="line-number" id="L16">16</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="16">@@ -22,7 &#43;22,6 @@</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L17">17</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="17"> #include &lt;string.h&gt;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L18">18</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="18"> #include &lt;ev.h&gt;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L19">19</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="19"> #include &lt;sys/mman.h&gt;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L20">20</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="20">-#include &lt;sys/wait.h&gt;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L21">21</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="21"> #include &lt;X11/XKBlib.h&gt;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L22">22</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="22"> #include &lt;X11/extensions/XKBfile.h&gt;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L23">23</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="23"> #include &lt;xkbcommon/xkbcommon.h&gt;</pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L24">24</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="24">@@ -32,6 &#43;31,7 @@</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L25">25</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="25"> #include &#34;i3lock.h&#34;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L26">26</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="26"> #include &#34;xcb.h&#34;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L27">27</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="27"> #include &#34;cursors.h&#34;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L28">28</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="28">&#43;#include &#34;pthread.h&#34;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L29">29</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="29"> #include &#34;unlock_indicator.h&#34;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L30">30</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="30"> #include &#34;xinerama.h&#34;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L31">31</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="31"> </pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L32">32</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="32">@@ -45,13 &#43;45,14 @@ static pam_handle_t *pam_handle;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L33">33</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="33"> int input_position = 0;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L34">34</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="34"> /* Holds the password you enter (in UTF-8). */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L35">35</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="35"> static char password[512];</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L36">36</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="36">&#43;/* Holds the password to be verified (in UTF-8). */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L37">37</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="37">&#43;static char pam_password[512];</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L38">38</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="38"> static bool beep = false;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L39">39</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="39"> bool debug_mode = false;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L40">40</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="40"> static bool dpms = false;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L41">41</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="41"> bool unlock_indicator = true;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L42">42</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="42"> static bool dont_fork = false;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L43">43</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="43"> struct ev_loop *main_loop;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L44">44</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="44">-static struct ev_timer *clear_pam_wrong_timeout;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L45">45</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="45"> extern unlock_state_t unlock_state;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L46">46</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="46"> extern pam_state_t pam_state;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L47">47</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="47"> </pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L48">48</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="48">@@ -63,6 &#43;64,9 @@ cairo_surface_t *img = NULL;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L49">49</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="49"> bool tile = false;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L50">50</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="50"> bool ignore_empty_password = false;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L51">51</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="51"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L52">52</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="52">&#43;static int waiting_authentication = 0;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L53">53</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="53">&#43;static int max_waiting_authentication = 4;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L54">54</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="54">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L55">55</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="55"> /* isutf, u8_dec Â© 2005 Jeff Bezanson, public domain */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L56">56</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="56"> #define isutf(c) (((c) &amp; 0xC0) != 0x80)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L57">57</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="57"> </pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L58">58</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="58">@@ -157,11 &#43;161,11 @@ out:</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L59">59</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="59">  * cold-boot attacks.</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L60">60</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="60">  *</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L61">61</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="61">  */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L62">62</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="62">-static void clear_password_memory(void) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L63">63</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="63">&#43;static void clear_password_memory(char *mem) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L64">64</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="64">     /* A volatile pointer to the password buffer to prevent the compiler from</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L65">65</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="65">      * optimizing this out. */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L66">66</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="66">-    volatile char *vpassword = password;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L67">67</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="67">-    for (int c = 0; c &lt; sizeof(password); c&#43;&#43;)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L68">68</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="68">&#43;    volatile char *vpassword = mem;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L69">69</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="69">&#43;    for (int c = 0; c &lt; sizeof(mem); c&#43;&#43;)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L70">70</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="70">         /* We store a non-random pattern which consists of the (irrelevant)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L71">71</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="71">          * index plus (!) the value of the beep variable. This prevents the</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L72">72</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="72">          * compiler from optimizing the calls away, since the value of &#39;beep&#39;</pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L73">73</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="73">@@ -169,28 &#43;173,28 @@ static void clear_password_memory(void) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L74">74</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="74">         vpassword[c] = c &#43; (int)beep;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L75">75</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="75"> }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L76">76</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="76"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L77">77</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="77">-</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L78">78</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="78"> /*</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L79">79</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="79">  * Resets pam_state to STATE_PAM_IDLE 2 seconds after an unsuccesful</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L80">80</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="80">  * authentication event.</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L81">81</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="81">  *</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L82">82</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="82">  */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L83">83</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="83">-static void clear_pam_wrong(EV_P_ ev_timer *w, int revents) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L84">84</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="84">-    DEBUG(&#34;clearing pam wrong\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L85">85</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="85">-    pam_state = STATE_PAM_IDLE;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L86">86</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="86">-    unlock_state = STATE_STARTED;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L87">87</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="87">-    redraw_screen();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L88">88</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="88">-</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L89">89</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="89">-    /* Now free this timeout. */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L90">90</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="90">-    ev_timer_stop(main_loop, clear_pam_wrong_timeout);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L91">91</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="91">-    free(clear_pam_wrong_timeout);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L92">92</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="92">-    clear_pam_wrong_timeout = NULL;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L93">93</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="93">&#43;static void clear_pam_wrong() {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L94">94</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="94">&#43;    /* Clear the pam_wrong sign and go idle if we are in the correct state */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L95">95</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="95">&#43;    if (__sync_bool_compare_and_swap(</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L96">96</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="96">&#43;                &amp;pam_state, STATE_PAM_WRONG, STATE_PAM_IDLE)) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L97">97</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="97">&#43;        unlock_state = STATE_STARTED;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L98">98</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="98">&#43;        redraw_screen();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L99">99</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="99">&#43;    }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L100">100</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="100"> }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L101">101</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="101"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L102">102</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="102">-static void clear_input(void) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L103">103</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="103">&#43;static void reset_password(void) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L104">104</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="104">     input_position = 0;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L105">105</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="105">-    clear_password_memory();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L106">106</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="106">&#43;    clear_password_memory(password);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L107">107</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="107">     password[input_position] = &#39;\0&#39;;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L108">108</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="108">&#43;}</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L109">109</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="109">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L110">110</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="110">&#43;static void clear_input(void) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L111">111</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="111">&#43;    reset_password();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L112">112</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="112"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L113">113</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="113">     /* Hide the unlock indicator after a bit if the password buffer is</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L114">114</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="114">      * empty. */</pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L115">115</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="115">@@ -200,78 &#43;204,106 @@ static void clear_input(void) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L116">116</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="116">     unlock_state = STATE_KEY_PRESSED;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L117">117</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="117"> }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L118">118</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="118"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L119">119</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="119">-static void auth_failed(void) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L120">120</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="120">-    if (debug_mode)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L121">121</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="121">-        fprintf(stderr, &#34;Authentication failure\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L122">122</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="122">&#43;static void *authenticate(void *arg) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L123">123</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="123">&#43;    /*</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L124">124</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="124">&#43;     * Here we can&#39;t just do :</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L125">125</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="125">&#43;     * while(__sync_bool_compare_and_swap(&amp;pam_state,</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L126">126</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="126">&#43;     *      STATE_PAM_VERIFY, STATE_PAM_VERIFY))</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L127">127</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="127">&#43;     *      ;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L128">128</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="128">&#43;     *</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L129">129</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="129">&#43;     * And then affect STATE_PAM_VERIFY to pam_state :</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L130">130</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="130">&#43;     * we need to do both in one single atomic operation, so we use comparison</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L131">131</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="131">&#43;     * on all the other states.</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L132">132</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="132">&#43;     *</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L133">133</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="133">&#43;     */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L134">134</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="134">&#43;    DEBUG(&#34;Waiting for critical section\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L135">135</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="135">&#43;    __sync_add_and_fetch(&amp;waiting_authentication, 1);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L136">136</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="136">&#43;    while (!__sync_bool_compare_and_swap(&amp;pam_state, STATE_PAM_IDLE, STATE_PAM_VERIFY)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L137">137</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="137">&#43;            &amp;&amp; !__sync_bool_compare_and_swap(&amp;pam_state, STATE_PAM_WRONG, STATE_PAM_VERIFY))</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L138">138</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="138">&#43;            ;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L139">139</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="139">&#43;    //Beginning of the Critical Section</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L140">140</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="140">&#43;    DEBUG(&#34;Entering critical section\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L141">141</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="141">&#43;    __sync_sub_and_fetch(&amp;waiting_authentication, 1);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L142">142</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="142">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L143">143</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="143">&#43;    /* Copy our private password to pam_password and clean */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L144">144</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="144">&#43;    char *the_password = (char *)arg;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L145">145</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="145">&#43;    memcpy(pam_password, the_password, sizeof(the_password));</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L146">146</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="146">&#43;    clear_password_memory(the_password);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L147">147</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="147">&#43;    free(the_password);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L148">148</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="148">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L149">149</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="149">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L150">150</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="150"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L151">151</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="151">-    pam_state = STATE_PAM_WRONG;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L152">152</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="152">     redraw_screen();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L153">153</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="153"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L154">154</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="154">-    /* Clear this state after 2 seconds (unless the user enters another</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L155">155</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="155">-     * password during that time). */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L156">156</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="156">-    ev_now_update(main_loop);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L157">157</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="157">-    if ((clear_pam_wrong_timeout = calloc(sizeof(struct ev_timer), 1))) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L158">158</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="158">-        ev_timer_init(clear_pam_wrong_timeout, clear_pam_wrong, 2.0, 0.);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L159">159</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="159">-        ev_timer_start(main_loop, clear_pam_wrong_timeout);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L160">160</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="160">&#43;    if (pam_authenticate(pam_handle, 0) == PAM_SUCCESS) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L161">161</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="161">&#43;        DEBUG(&#34;successfully authenticated\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L162">162</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="162">&#43;        clear_password_memory(password);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L163">163</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="163">&#43;        clear_password_memory(pam_password);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L164">164</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="164">&#43;        exit(0);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L165">165</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="165">     }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L166">166</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="166"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L167">167</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="167">-    /* Cancel the clear_indicator_timeout, it would hide the unlock indicator</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L168">168</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="168">-     * too early. */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L169">169</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="169">-    stop_clear_indicator_timeout();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L170">170</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="170">&#43;    if (debug_mode)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L171">171</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="171">&#43;        fprintf(stderr, &#34;Authentication failure\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L172">172</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="172">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L173">173</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="173">&#43;    /* Clear the pam_password memory (password has already been cleared) */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L174">174</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="174">&#43;    clear_password_memory(pam_password);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L175">175</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="175"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L176">176</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="176">     /* beep on authentication failure, if enabled */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L177">177</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="177">     if (beep) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L178">178</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="178">         xcb_bell(conn, 100);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L179">179</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="179">         xcb_flush(conn);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L180">180</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="180">     }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L181">181</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="181">-}</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L182">182</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="182">-</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L183">183</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="183">-static void child_cb(EV_P_ ev_child *child_watcher, int revents) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L184">184</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="184">-    if (child_watcher-&gt;rstatus != 0) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L185">185</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="185">-        DEBUG(&#34;Authentication successfull\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L186">186</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="186">-        clear_password_memory();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L187">187</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="187"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L188">188</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="188">-        exit(0);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L189">189</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="189">-    } else {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L190">190</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="190">-        auth_failed();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L191">191</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="191">&#43;    if (!__sync_bool_compare_and_swap(&amp;pam_state,</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L192">192</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="192">&#43;                STATE_PAM_VERIFY, STATE_PAM_WRONG)) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L193">193</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="193">&#43;        /*</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L194">194</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="194">&#43;         * This is an error : once pam_state = STATE_PAM_VERIFY,</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L195">195</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="195">&#43;         * only one thread can access it, so the comparison should</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L196">196</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="196">&#43;         * always be true. The atomic operation is here to ensure data</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L197">197</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="197">&#43;         * coherency with the main thread.</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L198">198</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="198">&#43;         * Can&#39;t exit now as it would unlock the screen, so just return.</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L199">199</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="199">&#43;         */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L200">200</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="200">&#43;        fprintf(stderr, &#34;i3lock : pam_state is not \&#34;verify\&#34; within\</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L201">201</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="201">&#43;                critical section\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L202">202</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="202">&#43;        return 0;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L203">203</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="203">     }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L204">204</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="204">-    ev_child_stop(main_loop, child_watcher);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L205">205</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="205">-    free(child_watcher);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L206">206</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="206">&#43;    DEBUG(&#34;Leaving critical section\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L207">207</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="207">&#43;    //End of Critical Section</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L208">208</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="208">&#43;    redraw_screen();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L209">209</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="209">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L210">210</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="210">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L211">211</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="211">&#43;    /* Cancel the clear_indicator_timeout, it would hide the unlock indicator</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L212">212</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="212">&#43;     * too early. */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L213">213</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="213">&#43;    stop_clear_indicator_timeout();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L214">214</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="214">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L215">215</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="215">&#43;    /* Wait for 2 seconds and maybe clear the pam_wrong state */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L216">216</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="216">&#43;    sleep(2);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L217">217</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="217">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L218">218</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="218">&#43;    clear_pam_wrong();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L219">219</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="219">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L220">220</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="220">&#43;    return 0;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L221">221</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="221"> }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L222">222</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="222"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L223">223</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="223"> static void input_done(void) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L224">224</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="224">-    if (pam_state == STATE_PAM_VERIFY) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L225">225</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="225">&#43;    if (waiting_authentication &gt; max_waiting_authentication)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L226">226</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="226">         return;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L227">227</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="227">-    }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L228">228</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="228">-</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L229">229</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="229">-    if (clear_pam_wrong_timeout) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L230">230</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="230">-        ev_timer_stop(main_loop, clear_pam_wrong_timeout);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L231">231</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="231">-        free(clear_pam_wrong_timeout);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L232">232</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="232">-        clear_pam_wrong_timeout = NULL;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L233">233</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="233">-    }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L234">234</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="234">&#43;    char *threadprivate_password = malloc(sizeof(password));</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L235">235</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="235">&#43;    if (threadprivate_password) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L236">236</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="236">&#43;        memcpy(threadprivate_password, password, sizeof(password));</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L237">237</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="237"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L238">238</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="238">-    pam_state = STATE_PAM_VERIFY;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L239">239</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="239">-    redraw_screen();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L240">240</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="240">&#43;        /* The thread */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L241">241</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="241">&#43;        pthread_t auth_thread;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L242">242</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="242"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L243">243</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="243">-    /* fork to unblock pam_authenticate */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L244">244</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="244">-    pid_t cpid = fork();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L245">245</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="245">-    if (cpid == 0) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L246">246</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="246">-        exit(pam_authenticate(pam_handle, 0) == PAM_SUCCESS);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L247">247</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="247">-    } else if (cpid &gt; 0) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L248">248</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="248">-        clear_input();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L249">249</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="249">-        struct ev_child *child_watcher = calloc(sizeof(struct ev_io), 1);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L250">250</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="250">-        ev_child_init(child_watcher, child_cb, cpid, 0);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L251">251</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="251">-        ev_child_set(child_watcher, cpid, 0);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L252">252</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="252">-        ev_child_start(EV_DEFAULT_ child_watcher);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L253">253</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="253">-    } else if (cpid &lt; 0) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L254">254</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="254">-        DEBUG(&#34;Could not fork&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L255">255</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="255">-        if (pam_authenticate(pam_handle, 0) == PAM_SUCCESS) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L256">256</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="256">-            DEBUG(&#34;successfully authenticated\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L257">257</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="257">-            clear_password_memory();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L258">258</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="258">-            exit(0);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L259">259</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="259">&#43;        /* Create the authentication thread, if it fails, do it in main thread */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L260">260</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="260">&#43;        if(pthread_create(&amp;auth_thread, NULL, authenticate, threadprivate_password)) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L261">261</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="261">&#43;            fprintf(stderr, &#34;Error creating thread, going sequential.\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L262">262</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="262">&#43;            authenticate(threadprivate_password);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L263">263</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="263">         }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L264">264</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="264">-        auth_failed();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L265">265</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="265">&#43;    } else {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L266">266</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="266">&#43;        authenticate(password);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L267">267</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="267">     }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L268">268</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="268">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L269">269</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="269">&#43;    reset_password();</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L270">270</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="270"> }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L271">271</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="271"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L272">272</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="272"> /*</pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L273">273</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="273">@@ -472,7 &#43;504,7 @@ static int conv_callback(int num_msg, const struct pam_message **msg,</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L274">274</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="274"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L275">275</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="275">         /* return code is currently not used but should be set to zero */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L276">276</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="276">         resp[c]-&gt;resp_retcode = 0;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L277">277</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="277">-        if ((resp[c]-&gt;resp = strdup(password)) == NULL) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L278">278</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="278">&#43;        if ((resp[c]-&gt;resp = strdup(pam_password)) == NULL) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L279">279</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="279">             perror(&#34;strdup&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L280">280</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="280">             return 1;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L281">281</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="281">         }</pre>
  </td>
  </tr>


</table>
</div>


</div>

  </body>
</html>

