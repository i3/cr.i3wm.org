
<!DOCTYPE html>
<html>
  <head>
    <title>i3 Patch: Bugfix: Don&#39;t set input focus to window that has been closed</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" media="screen" href="http://i3wm.org/css/style.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/public/stylesheets/main.css">
    <link rel="shortcut icon" type="image/png" href="http://i3wm.org/favicon.png">
    <script src="/public/js/jquery-1.9.0.min.js" type="text/javascript" charset="utf-8"></script>
	<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
    
    
      <script src="/public/js/patch.js" type="text/javascript" charset="utf-8"></script>
    
  </head>
  <body>


<div id="main">
	<a href="/"><h1 id="title">i3 - improved tiling WM</h1></a>
				<ul id="nav">
						<li><a style="border-bottom: 2px solid #fff" href="/">Reviews</a></li>
						<li><a href="http://bugs.i3wm.org/">Bugs</a></li>
				</ul>
<br style="clear: both">

<div id="content">

<h1>Bugfix: Don&#39;t set input focus to window that has been closed</h1>
<div style="float: right">
<p>
Patch status: needinfo
</p>
<p>
Patch by Marco Hunsicker
</p>
</div>

<p>
<strong>Long description</strong>:<br>
<pre>This patch adjusts the point in time the focus is transferred when
a window is closed to avoid having the input focus set (again) to
the already detached window.

Fixes #1185
</pre>
</p>


<p>
To apply this patch, use:<br>
<code>curl http://cr.i3wm.org/patch/424/raw.patch | git am</code>
</p>




<div style="border: 1px solid #ccc; margin: 1em; width: 880px; overflow-x: auto; background-color: #eaeaea; color: #000;">
<h2 style="margin: 0; padding: .5em; color: #000;">b/src/tree.c</h2>
<table class="patch" cellpadding="0" cellspacing="0">


  <tr class="linerow">
  <td class="line-number" id="L18">18</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="18">@@ -295,6 &#43;295,27 @@ bool tree_close(Con *con, kill_window_t kill_window, bool dont_kill_parent, bool</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L19">19</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="19">         con_fix_percent(parent);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L20">20</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="20">     }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L21">21</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="21"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L22">22</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="22">&#43;    if (next) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L23">23</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="23">&#43;        if (was_mapped || con == focused) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L24">24</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="24">&#43;            if ((kill_window != DONT_KILL_WINDOW) || !dont_kill_parent || con == focused) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L25">25</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="25">&#43;                DLOG(&#34;focusing %p / %s\n&#34;, next, next-&gt;name);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L26">26</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="26">&#43;                if (next-&gt;type == CT_DOCKAREA) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L27">27</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="27">&#43;                    /* Instead of focusing the dockarea, we need to restore focus to the workspace  */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L28">28</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="28">&#43;                    con_focus(con_descend_focused(output_get_content(next-&gt;parent)));</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L29">29</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="29">&#43;                } else {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L30">30</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="30">&#43;                    if (!force_set_focus &amp;&amp; con != focused)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L31">31</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="31">&#43;                        DLOG(&#34;not changing focus, the container was not focused before\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L32">32</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="32">&#43;                    else con_focus(next);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L33">33</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="33">&#43;                }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L34">34</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="34">&#43;            }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L35">35</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="35">&#43;            else {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L36">36</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="36">&#43;                DLOG(&#34;not focusing because we&#39;re not killing anybody\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L37">37</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="37">&#43;            }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L38">38</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="38">&#43;        } else {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L39">39</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="39">&#43;            DLOG(&#34;not focusing, was not mapped\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L40">40</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="40">&#43;        }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L41">41</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="41">&#43;    }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L42">42</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="42">&#43;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L43">43</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="43">     /* Render the tree so that the surrounding containers take up the space</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L44">44</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="44">      * which &#39;con&#39; does no longer occupy. If we donâ€™t render here, there will</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L45">45</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="45">      * be a gap in our containers and that could trigger an EnterNotify for an</pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L46">46</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="46">@@ -327,25 &#43;348,6 @@ bool tree_close(Con *con, kill_window_t kill_window, bool dont_kill_parent, bool</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L47">47</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="47">         return true;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L48">48</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="48">     }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L49">49</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="49"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L50">50</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="50">-    if (was_mapped || con == focused) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L51">51</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="51">-        if ((kill_window != DONT_KILL_WINDOW) || !dont_kill_parent || con == focused) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L52">52</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="52">-            DLOG(&#34;focusing %p / %s\n&#34;, next, next-&gt;name);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L53">53</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="53">-            if (next-&gt;type == CT_DOCKAREA) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L54">54</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="54">-                /* Instead of focusing the dockarea, we need to restore focus to the workspace */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L55">55</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="55">-                con_focus(con_descend_focused(output_get_content(next-&gt;parent)));</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L56">56</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="56">-            } else {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L57">57</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="57">-                if (!force_set_focus &amp;&amp; con != focused)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L58">58</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="58">-                    DLOG(&#34;not changing focus, the container was not focused before\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L59">59</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="59">-                else con_focus(next);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L60">60</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="60">-            }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L61">61</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="61">-        }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L62">62</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="62">-        else {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L63">63</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="63">-            DLOG(&#34;not focusing because we&#39;re not killing anybody\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L64">64</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="64">-        }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L65">65</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="65">-    } else {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L66">66</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="66">-        DLOG(&#34;not focusing, was not mapped\n&#34;);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L67">67</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="67">-    }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L68">68</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="68">-</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L69">69</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="69">     /* check if the parent container is empty now and close it */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L70">70</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="70">     if (!dont_kill_parent)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L71">71</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="71">         CALL(parent, on_remove_child);</pre>
  </td>
  </tr>


</table>
</div>


</div>

  </body>
</html>

