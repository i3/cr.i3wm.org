
<!DOCTYPE html>
<html>
  <head>
    <title>i3 Patch: i3bar: Realign tray clients on UnmapNotify</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" media="screen" href="http://i3wm.org/css/style.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/public/stylesheets/main.css">
    <link rel="shortcut icon" type="image/png" href="http://i3wm.org/favicon.png">
    <script src="/public/js/jquery-1.9.0.min.js" type="text/javascript" charset="utf-8"></script>
	<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
    
    
      <script src="/public/js/patch.js" type="text/javascript" charset="utf-8"></script>
    
  </head>
  <body>


<div id="main">
	<a href="/"><h1 id="title">i3 - improved tiling WM</h1></a>
				<ul id="nav">
						<li><a style="border-bottom: 2px solid #fff" href="/">Reviews</a></li>
						<li><a href="http://bugs.i3wm.org/">Bugs</a></li>
				</ul>
<br style="clear: both">

<div id="content">

<h1>i3bar: Realign tray clients on UnmapNotify</h1>
<div style="float: right">
<p>
Patch status: superseded
</p>
<p>
Patch by Tony Crisci
</p>
</div>

<p>
<strong>Long description</strong>:<br>
<pre>UnmapNotify events are interpreted by i3bar as an action taken by an
application to hide its tray window. We respond by adjusting the size of
the tray window and realigning any tray clients that remain. This will
close the gap left by the unmapping window.

Breaking change! The tray will not be properly readjusted if the
application remaps its tray window.
</pre>
</p>


<p>
To apply this patch, use:<br>
<code>curl http://cr.i3wm.org/patch/331/raw.patch | git am</code>
</p>




<div style="border: 1px solid #ccc; margin: 1em; width: 880px; overflow-x: auto; background-color: #eaeaea; color: #000;">
<h2 style="margin: 0; padding: .5em; color: #000;">b/i3bar/src/xcb.c</h2>
<table class="patch" cellpadding="0" cellspacing="0">


  <tr class="linerow">
  <td class="line-number" id="L20">20</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="20">@@ -433,8 &#43;433,9 @@ void handle_button(xcb_button_press_event_t *event) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L21">21</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="21"> }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L22">22</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="22"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L23">23</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="23"> /*</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L24">24</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="24">- * Configures the x coordinate of all trayclients. To be called after adding a</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L25">25</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="25">- * new tray client or removing an old one.</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L26">26</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="26">&#43; * Adjusts the size of the tray window and alignment of the tray clients by</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L27">27</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="27">&#43; * configuring their respective x coordinates. To be called when mapping or</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L28">28</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="28">&#43; * unmapping a tray client window.</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L29">29</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="29">  *</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L30">30</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="30">  */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L31">31</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="31"> static void configure_trayclients(void) {</pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L32">32</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="32">@@ -656,8 &#43;657,8 @@ static void handle_destroy_notify(xcb_destroy_notify_event_t* event) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L33">33</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="33"> }</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L34">34</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="34"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L35">35</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="35"> /*</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L36">36</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="36">- * Handles UnmapNotify events. These events happen when a tray window unmaps</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L37">37</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="37">- * itself. We then update our data structure</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L38">38</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="38">&#43; * Handles UnmapNotify events. These events happen when a tray client hides its</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L39">39</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="39">&#43; * window. We respond by realigning the tray clients.</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L40">40</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="40">  *</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L41">41</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="41">  */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L42">42</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="42"> static void handle_unmap_notify(xcb_unmap_notify_event_t* event) {</pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L43">43</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="43">@@ -673,8 &#43;674,8 @@ static void handle_unmap_notify(xcb_unmap_notify_event_t* event) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L44">44</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="44">             if (trayclient-&gt;win != event-&gt;window)</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L45">45</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="45">                 continue;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L46">46</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="46"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L47">47</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="47">-            DLOG(&#34;Removing tray client with window ID %08x\n&#34;, event-&gt;window);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L48">48</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="48">-            TAILQ_REMOVE(walk-&gt;trayclients, trayclient, tailq);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L49">49</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="49">&#43;            DLOG(&#34;Tray client unmapped (window ID %08x). Adjusting tray.\n&#34;, event-&gt;window);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L50">50</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="50">&#43;            trayclient-&gt;mapped = false;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L51">51</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="51"> </pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L52">52</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="52">             /* Trigger an update, we now have more space for the statusline */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L53">53</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="53">             configure_trayclients();</pre>
  </td>
  </tr>



  <tr class="linerow">
  <td class="line-number" id="L54">54</td>
  <td width="100%" class="line hunk">
	  <b class="add-bubble"></b>
	  <pre data-nr="54">@@ -836,7 &#43;837,7 @@ void xcb_chk_cb(struct ev_loop *loop, ev_check *watcher, int revents) {</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L55">55</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="55">                 handle_destroy_notify((xcb_destroy_notify_event_t*) event);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L56">56</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="56">                 break;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L57">57</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="57">             case XCB_UNMAP_NOTIFY:</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L58">58</td>
  <td width="100%" class="line del">
	  <b class="add-bubble"></b>
	  <pre data-nr="58">-                /* UnmapNotifies are received when a tray window unmaps itself */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L59">59</td>
  <td width="100%" class="line add">
	  <b class="add-bubble"></b>
	  <pre data-nr="59">&#43;                /* UnmapNotify is received when a tray client hides its window. */</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L60">60</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="60">                 handle_unmap_notify((xcb_unmap_notify_event_t*) event);</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L61">61</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="61">                 break;</pre>
  </td>
  </tr>

  <tr class="linerow">
  <td class="line-number" id="L62">62</td>
  <td width="100%" class="line ">
	  <b class="add-bubble"></b>
	  <pre data-nr="62">             case XCB_PROPERTY_NOTIFY:</pre>
  </td>
  </tr>


</table>
</div>


</div>

  </body>
</html>

